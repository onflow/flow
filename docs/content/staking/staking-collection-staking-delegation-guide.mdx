---
title: How to Stake using a Staking Collection
sidebar_title: Stake using a Staking Collection
---

This document outlines the steps an account can take to perform staking (node or delegator) actions using a Staking Collection.

## Staking Collection Overview

A Staking Collection is a resource that allows its owner to manage multiple staking
objects in a single account via a single storage path, and perform staking actions using both locked and unlocked Flow.

Before the staking collection, accounts could use the instructions in [the unlocked staking guide](https://docs.onflow.org/staking/unlocked-staking-guide/)
to stake with tokens. This was a bit restrictive, because that guide (and the corresponding transactions) only supports one node and one delegator object
per account. If a user wanted to have more than one per account, they would either have to use custom transactions with custom storage paths for each object,
or they would have had to use multiple accounts, which comes with many hassles of its own.

The same applies to the [locked tokens staking guide](https://docs.onflow.org/staking/locked-staking-guide/).
We only built in support for one node and one delegator per account.

The staking collection is a solution to both of these deficiencies. When an account is set up to use a staking collection,
the staking collection recognizes the existing locked account capabilities (if they exist) and unlocked account staking objects,
and incorporates their functionality so any user can stake for a node or stake as a delegator through a single common interface, regardless of
if they have a brand new account, or have been staking through the locked account or unlocked account before.

The staking collection has two main fields, 
```cadence
access(self) var nodeStakers: @{String: FlowIDTableStaking.NodeStaker}
access(self) var nodeDelegators: @{String: FlowIDTableStaking.NodeDelegator}
```
These dictionaries store the staking objects that are managed by the staking collection.
Access to these dictionaries are mediated by the staking methods. When a user wants to perform a staking operation,
they specify the nodeID and/or delegatorID they want to stake for, and the function routes the function
call to the correct staking object and performs the specified operation.

The staking collection also has a field that stores a capability for the unlocked FLOW Vault and locked FLOW vault (if applicable)
```cadence
/// unlocked vault
access(self) var unlockedVault: Capability<&FlowToken.Vault>

/// locked vault
/// will be nil if the account has no corresponding locked account
access(self) var lockedVault: Capability<&FlowToken.Vault>?
```

When a user performs staking operations like staking new tokens, the staking collection tracks the number of unlocked tokens
and locked tokens (if applicable) that are used by the staking objects in the collection. 
The collection will always try to stake any available locked tokens first.
Once all locked tokens are staked, if the user requested to stake more than the locked token balance, the collection
will then dip into the unlocked balance for the remaining tokens. If the user has no locked tokens, the staking collection 
will simply ignore the locked tokens part of the functionality and only use unlocked tokens.

When a user withdraws tokens from a staking object, the collection will always try to withdraw unlocked tokens first.
Any unlocked tokens are then deposited directly into the vault on the unlocked account, and remaining locked tokens are deposited
to the vault in the locked account.

The staking collection also defines many getter methods to query information about an account's staking collection.
You can simply call one of these methods on the contract, providing the account address, and the contract will retreive
the relevant info for you, like so:
```cadence
import FlowStakingCollection from 0xSTAKINGCOLLECTIONADDRESS
import FlowIDTableStaking from 0xIDENTITYTABLEADDRESS

/// Gets an array of all the delegator metadata for delegators stored in the staking collection
pub fun main(address: Address): [FlowIDTableStaking.DelegatorInfo] {
    return FlowStakingCollection.getAllDelegatorInfo(address: address)
}
```

Remember: A Staking Collection does not require an account to have a secondary locked account or locked FLOW.
However, if an account does an associated locked account, when the Staking Collection is initialized, it will connect to that locked account's 
node and delegator objects as well as it's locked token vault allowing it to perform staking actions with locked and unlocked FLOW.

<Callout type="info">
Staking Collection is backwards compatible with other methods of staking on Flow. Existing accounts with associated locked accounts
will still be able to stake in the same way as before, but they will also be able to use the staking collection, if desired.
</Callout>

## Setup Staking Collection

To set up a Staking Collection, you must run the **Setup Staking Collection** ([SL.01](/core-contracts/staking-collection)) transaction.
This transaction requires no arguments and will perform the following actions:
1. Create private capabilities for the unlocked vault and locked vault (if applicable).
2. Create a new staking collection resource object, initializing it with the unlocked and locked vault capabilities.
3. Store the staking collection at a pre-defined storage path.
4. Create a public link to the staking collection so others can query metadata about it.
5. If there are any node or delegator objects in the unlocked account, the transaction stores those in the staking collection
   so they can be used through the same interface as usual.

Once this transaction is complete, your existing staking objects (if any) from your unlocked account and locked account
will be available via the staking collection and you can use all the transactions described below to access them.

## Register a New Staked Node

To register a new staked node, you must submit the **Register Node** ([SL.2](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument              | Type     | Description |
|-----------------------|----------|-------------|
| **id**                | `String` | The ID of the new node. It must be a 32 byte `String`. The operator is free to choose this value, but it must be unique across all nodes. A recommended process to generate this is to hash the staking public key. |
| **role**              | `UInt8`  | The role of the new node. (1: collection, 2: consensus, 3: execution, 4: verification, 5: access) |
| **networkingAddress** | `String` | The IP address of the new node. |
| **networkingKey**     | `String` | The networking public key as a hex-encoded string. |
| **stakingKey**        | `String` | The staking public key as a hex-encoded string. |
| **amount**            | `UFix64` | The number of FLOW tokens to stake. |

This transaction registers the account as a staker with the specified node information
and attaches a `NodeStaker` resource to the `Staking Collection`. 
This `NodeStaker` resourece can then later be used to perform staking actions via the staking collection staking methods.

Once the account has registered their node using their Staking Collection,
their tokens and node information are committed to the central staking contract for the next epoch.

At this point, the Staking Collection now has access to various staking operations that they can perform,
assuming they have the correct number of tokens to perform the action.

## Register a New Delegator

To register a new delegator, you must submit the **Register Delegator** ([SL.3](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument   | Type     | Description |
|------------|----------|-------------|
| **id**     | `String` | The ID of the node to delegate to. |
| **amount** | `UFix64` | The number of FLOW tokens to delegate. |

This transaction registers the account as a delegator to the node identified by the supplied node id.
It also attaches a `NodeDelegator` resource to the `Staking Collection`. 
This `NodeDelegator` resourece can then later be used to perform delegation actions.

Once the account has registered their new delegator using their Staking Collection,
their tokens are committed to the central staking contract for the next epoch.

At this point, the Staking Collection now has access to various delegator operations that they can perform,
assuming they have the correct number of tokens to perform the action.

## Stake New Tokens

The Staking Collection can stake additional tokens for any Node or Delegator managed by it at any time.

### Stake new tokens for an active Node

The owner of a Staking Collection can use the **Stake New Tokens** ([SL.04](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to stake new tokens to. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to stake. |

<Callout type="info">
To stake new tokens for an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

The amount may be any number of tokens up to the sum of an accounts locked and unlocked FLOW.

### Stake new tokens for an active Delegator

The owner of a Staking Collection can use the **Stake New Tokens** ([SL.04](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to stake new tokens to. |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to stake new tokens to. |
| **amount**              | `UFix64`           | The number of FLOW tokens to stake. |

The amount may be any number of tokens up to the sum of an accounts locked and unlocked FLOW.

## Re-stake Unstaked Tokens

After tokens become unstaked, the owner of a Staking Collection can choose to re-stake the unstaked tokens to the same Node or Delegator.

### Re-stake Unstaked Tokens for an active Node

The owner of a Staking Collection can use the **Stake Unstaked Tokens** ([SL.05](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to stake the unstaked tokens to. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to restake. |

<Callout type="info">
To stake unstaked tokens for an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Re-stake Unstaked Tokens for an active Delegator

The owner of a Staking Collection can use the **Stake Unstaked Tokens** ([SL.05](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to stake the unstaked tokens to. |
| **amount**              | `UFix64`           | The number of FLOW tokens to restake. |

## Re-stake Rewarded Tokens

After earning rewards from staking, the owner of a Staking Collection can choose to re-stake the rewarded tokens to the same node.

### Re-stake Rewarded Tokens for an active Node

The owner of a Staking Collection can use the **Stake Unstaked Tokens** ([SL.05](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to stake the rewarded tokens to. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to restake. |

<Callout type="info">
To stake rewarded tokens for an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Re-stake Rewarded Tokens for an active Delegator

The owner of a Staking Collection can use the **Stake Unstaked Tokens** ([SL.05](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to stake the rewarded tokens to. |
| **amount**              | `UFix64`           | The number of FLOW tokens to restake. |

## Unstake Tokens

The owner of a Staking Collection can submit a request to unstake their tokens at any time for any Node or Delegator in their collection.

If the tokens aren't staked yet, they will be uncommitted and available to withdraw.

_Note: unstaked tokens will be held by the central staking contract until the end of the following epoch. 
Once the tokens are released (unstaked), they can be claimed via the 
[Withdraw Unstaked Tokens](#withdraw-unstaked-tokens) action below.

### Unstake Tokens from an active Node

The owner of a Staking Collection can use the **Unstake Tokens** ([SL.06](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the chosen node. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to restake. |

<Callout type="info">
To unstake tokens from an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Unstake ALL Tokens from an active Node

The owner of a Staking Collection can use the **Unstake All** ([SL.07](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to unstake all tokens from. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |

### Unstake ALL Tokens from an active Node

The owner of a Staking Collection can use the **Unstake All** ([SL.07](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to unstake all tokens from. |
| **delegatorID**         | `Optional(UInt32)` | The ID of the chosen delegator |

### Unstake Tokens from an active Delegator

The owner of a Staking Collection can use the **Unstake Tokens** ([SL.06](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to unstake the tokens from. |
| **amount**              | `UFix64`           | The number of FLOW tokens to unstake. |

## Withdraw Unstaked Tokens

After tokens for an active Node or Delegator become unstaked, the ownder of Staking Collection can withdraw them from the central staking contract.

### Withdraw Unstaked Tokens from an active Node

The owner of a Staking Collection can use the **Withdraw Unstaked Tokens** ([SL.08](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to withdraw the unstaked tokens from. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to withdraw. |

<Callout type="info">
To withdraw unstaked tokens from an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Withdraw Unstaked Tokens from an active Delegator

The owner of a Staking Collection can use the **Withdraw Unstaked Tokens** ([SL.08](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to withdraw the unstaked tokens from. |
| **amount**              | `UFix64`           | The number of FLOW tokens to withdraw. |

## Withdraw Rewarded Tokens

After earning rewards from staking, the token holder can withdraw them from the central staking contract.

### Withdraw Rewarded Tokens from an active Node

The owner of a Staking Collection can use the **Withdraw Rewarded Tokens** ([SL.09](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to withdraw the rewarded tokens from. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |
| **amount**              | `UFix64`           | The number of FLOW tokens to withdraw. |

<Callout type="info">
To withdraw rewarded tokens from an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Withdraw Rewarded Tokens from an active Delegator

The owner of a Staking Collection can use the **Withdraw Rewarded Tokens** ([SL.09](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to withdraw the rewarded tokens from. |
| **amount**              | `UFix64`           | The number of FLOW tokens to withdraw. |

## Close a Node or Delegator

One a Node or Delegator has no tokens staked, comitted or in an unstaking state, it is eligible to be closed.

Closing a Node or Delegator first returns any unstaked or rewarded tokens to the account for which the Staking Collection is stored in.
It then destroys the NodeStaker or NodeDelegator object from within the Staking Collection.

_Note: Once a Node or Delegator has been closed, it cannot be accessed again, and no staking or delegation actions can be futher preformed on it._

### Close an active Node

The owner of a Staking Collection can use the **Close Stake** ([SL.10](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node to close. |
| **delegatorID**         | `Optional(UInt32)` | Unneeded - Leave as `nil` |

<Callout type="info">
To close an active node, leave the <b>delegatorID</b> arguement as <b>nil</b>.
</Callout>

### Close an active Delegator

The owner of a Staking Collection can use the **Close Stake** ([SL.19](/core-contracts/staking-collection))
transaction with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **nodeID**              | `String`           | The nodeID of the node delegating to.  |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to close. |

## Get All Node Info

To return an array of structs representing the information associated with each node managed by an account's Staking Collection, anyone
can use the **Get All Node Info** ([SL.12](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns an array of `FlowIDTableStaking.NodeInfo` [structs](https://github.com/onflow/flow-core-contracts/blob/master/contracts/FlowIDTableStaking.cdc#L264)
representing the nodes managed by an accounts Staking Collection.

## Get All Delegator Info

To return an array of structs representing the information associated with each delegator managed by an account's Staking Collection, anyone
can use the **Get All Delegator Info** ([SL.11](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns an array of `FlowIDTableStaking.DelegatorInfo` [structs](https://github.com/onflow/flow-core-contracts/blob/master/contracts/FlowIDTableStaking.cdc#L264)
representing the delegators managed by an accounts Staking Collection.

## Get All Node Ids

To return an array of Strings representing the ids associated with each node managed by an account's Staking Collection, anyone
can use the **Get All Node Ids** ([SL.14](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns an array of `String`
representing each id of each node managed by an accounts Staking Collection.

## Get All Delegator Ids

To return an array of structs representing the delegator ids associated with each delegation managed by an account's Staking Collection, anyone
can use the **Get All Delegator Ids** ([SL.13](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns an array of `FlowStakingCollection.DelegatorIDs` [structs](https://github.com/onflow/flow-core-contracts/blob/master/contracts/FlowStakingCollection.cdc#L29)
representing the delegator Ids of each delegator managed by an accounts Staking Collection.

## Get Locked Tokens Used

To query how many Locked FLOW tokens an account has staked using their Staking Collection, anyone
can use the **Get Locked Tokens Used** ([SL.16](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns a `UFix64` representing the number of Locked FLOW tokens staked using an accounts Staking Collection.

<Callout type="info">
Note: This number does not include Locked FLOW tokens staked not through an accounts Staking Collection.
</Callout>

## Get Unlocked Tokens Used

To query how many Unlocked FLOW tokens an account has staked using their Staking Collection, anyone
can use the **Get Unlocked Tokens Used** ([SL.17](/core-contracts/staking-collection)) script with the following arguments:

| Argument    | Type       | Description |
|-------------|------------|-------------|
| **address** | `Addresss` | The Address of the account holding the Staking Collection to query from |

This script returns a `UFix64` representing the number of Unlocked FLOW tokens staked using an accounts Staking Collection.

<Callout type="info">
Note: This number does not include Unlocked FLOW tokens staked not through an accounts Staking Collection.
</Callout>

## Get Does Node Exist 

To query if a Node or Delegator is managed by an accounts Staking Collection, anyone
can use the **Get Does Node Exist** ([SL.15](/core-contracts/staking-collection)) script with the following arguments:

| Argument                | Type               | Description |
|-------------------------|--------------------|-------------|
| **address**             | `Addresss`         | The Address of the account holding the Staking Collection to query from |
| **nodeID**              | `String`           | The nodeID of the node to check, or the nodeID of the node delegating to to check. |
| **delegatorID**         | `Optional(UInt32)` | The delegatorID of the delegator to check, if checking for a delegator. |

<Callout type="info">
To query if a Node is managed by an accounts Staking Collection, leave the <b>delegatorID</b> arguement as <b>nil</b>. 
Otherwise, fill it in with the <b>delegatorID</b> of the Delegator.
</Callout>
